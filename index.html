<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>NS Small B2B</title>

  <!-- ‡∏ü‡∏≠‡∏ô‡∏ï‡πå + ‡∏ò‡∏µ‡∏° -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <!-- ‡πÇ‡∏´‡∏•‡∏î Google Maps JS API (‡πÉ‡∏ä‡πâ‡∏Ñ‡∏µ‡∏¢‡πå‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö Geocode/Distance) -->
  <script async src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDheFpt9gmMH_6Rb3vEKihQZTw2GvZ5NbA&v=weekly"></script>

  <link rel="icon" href="assets/dohome_logo.jpg">
  <style>
    :root{
      --orange:#f37021; --orange-600:#f37021; --orange-700:#dd5f14;
      --bg:#fff9f5; --ink:#18212f; --muted:#64748b;
      --card:#ffffff; --border:#f0e3da; --radius:16px; --chip:#fff1e7;
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--ink);font-family:'Prompt',system-ui,-apple-system,Segoe UI,Roboto,sans-serif;line-height:1.35}
    .wrap{max-width:1000px;margin:20px auto 64px;padding:0 14px}
    header{display:flex;align-items:center;gap:14px;margin-bottom:14px}
    .brand img{width:56px;height:56px;object-fit:contain;border-radius:12px;background:#fff;border:1px solid var(--border)}
    h1{font-size:26px;margin:0}
    .tag{color:var(--muted);font-size:14px}
    .ribbon{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:999px;background:#ffe8da;color:#9a3f12;border:1px dashed #ffc7a6;font-size:13px;font-weight:600}
    .grid4{display:grid;gap:12px;grid-template-columns:1fr}
    @media(min-width:760px){.grid4{grid-template-columns:1fr 1fr}}
    @media(min-width:980px){.grid4{grid-template-columns:1fr 1fr 1fr 1fr}}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px;box-shadow:0 8px 24px rgba(243,112,33,.10);display:flex;align-items:center;justify-content:center;text-align:center;gap:10px;cursor:pointer;font-weight:700}
    .card:active{transform:translateY(1px)}
    .hidden{display:none}
    .section{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px;box-shadow:0 8px 24px rgba(243,112,33,.10);margin-top:14px}
    .row{display:grid;grid-template-columns:1fr;gap:10px;margin-bottom:12px}
    @media(min-width:720px){.row.cols-2{grid-template-columns:1fr 1fr} .row.cols-3{grid-template-columns:1fr 1fr 1fr}}
    label{font-weight:600;font-size:14px;display:block;margin-bottom:6px}
    input[type="text"],input[type="date"],input[type="tel"],textarea,select{width:100%;padding:12px 14px;border:1px solid var(--border);border-radius:12px;background:#fff;font-size:15px;outline:none;transition:border .15s ease,box-shadow .15s ease}
    textarea{min-height:110px;resize:vertical}
    input:focus,textarea:focus,select:focus{border-color:var(--orange-600);box-shadow:0 0 0 3px rgba(243,112,33,.18)}
    .controls{display:flex;gap:10px;flex-wrap:wrap}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 12px;border-radius:12px;border:1px solid var(--border);background:#fff;cursor:pointer;font-weight:600}
    button.primary{width:100%;padding:14px 16px;border:none;border-radius:14px;background:linear-gradient(135deg,var(--orange-600),var(--orange-700));color:#fff;font-weight:700;font-size:16px;cursor:pointer}
    .status{margin-top:12px;font-size:14px}.success{color:#0f766e}.error{color:#b91c1c}
    .chips{display:flex;flex-wrap:wrap;gap:8px;padding:10px;border:1px solid var(--border);border-radius:12px;background:#fff;min-height:46px;cursor:text}
    .chip{display:inline-flex;align-items:center;gap:6px;background:var(--chip);border:1px solid #ffd6bf;padding:6px 10px;border-radius:999px;font-size:13px;font-weight:600}
    .chip button{all:unset;cursor:pointer;font-weight:700}
    .chip-input{border:none;outline:none;min-width:120px;font-size:15px;padding:6px}
    .hint{color:var(--muted);font-size:12px;margin-top:4px}
    #map{width:100%;height:520px;border-radius:12px;border:1px solid var(--border)}
    table{width:100%;border-collapse:collapse;font-size:14px}
    th,td{padding:8px 10px;border-bottom:1px solid var(--border);text-align:left}
    .menu-title{display:flex;align-items:center;gap:10px;margin:4px 0 10px;font-weight:700}
    .back{font-size:14px;cursor:pointer;color:#9a3f12}
  </style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="brand"><img src="assets/dohome_logo.jpg" alt="DoHome logo"></div>
    <div>
      <h1>NS Small B2B <span class="tag">‚ú®</span></h1>
      <div class="ribbon"> ‡∏î‡∏π‡πÇ‡∏Æ‡∏° ‡∏ô‡∏Ñ‡∏£‡∏™‡∏ß‡∏£‡∏£‡∏Ñ‡πå v.2 </div>
    </div>
  </header>

  <!-- ‡πÄ‡∏°‡∏ô‡∏π‡∏´‡∏•‡∏±‡∏Å 4 ‡∏õ‡∏∏‡πà‡∏° -->
  <div id="home" class="grid4">
    <div class="card" onclick="openSection('mapSec')">üó∫Ô∏è ‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</div>
    <div class="card" onclick="openSection('dashSec')">üìä Dashboard</div>
    <div class="card" onclick="openSection('lineSec')">üí¨ ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å (LINE)</div>
    <div class="card" onclick="openSection('formSec')">üìù ‡∏Å‡∏£‡∏≠‡∏Å‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏≠‡∏≠‡∏Å‡∏´‡∏≤‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</div>
  </div>

  <!-- SECTION: ‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ -->
  <section id="mapSec" class="section hidden">
    <div class="menu-title">
      <span class="back" onclick="backHome()">‚Üê ‡∏Å‡∏•‡∏±‡∏ö</span> üó∫Ô∏è ‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤
    </div>
    <div class="row cols-3">
      <div>
        <label>üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà (‡∏Å‡∏£‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)</label>
        <input type="date" id="mapFrom"> 
      </div>
      <div>
        <label>&nbsp;</label>
        <input type="date" id="mapTo">
      </div>
      <div>
        <label>üë• Team</label>
        <select id="mapTeam"><option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option><option>A</option><option>B</option><option>C</option><option>D</option></select>
      </div>
    </div>
    <div class="controls" style="margin-bottom:8px">
      <button class="btn" onclick="refreshMap()">üîÑ ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•/‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</button>
      <button class="btn" onclick="locateOnMap()">üìå ‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏ö‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà</button>
    </div>
    <div id="map"></div>
    <div class="hint">* ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ä‡∏µ‡πâ marker ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏á‡∏≤‡∏ô, ‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤, ‡∏ó‡∏µ‡∏°, ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</div>
  </section>

  <!-- SECTION: Dashboard -->
  <section id="dashSec" class="section hidden">
    <div class="menu-title">
      <span class="back" onclick="backHome()">‚Üê ‡∏Å‡∏•‡∏±‡∏ö</span> üìä Dashboard ‡∏™‡∏£‡∏∏‡∏õ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ï‡∏≤‡∏° ‡∏à./‡∏≠./‡∏ï.
    </div>
    <div class="row cols-3">
      <div>
        <label>‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î</label>
        <select id="filterChangwat"><option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option></select>
      </div>
      <div>
        <label>‡∏≠‡∏≥‡πÄ‡∏†‡∏≠</label>
        <select id="filterAmphoe"><option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option></select>
      </div>
      <div>
        <label>‡∏ï‡∏≥‡∏ö‡∏•</label>
        <select id="filterTambon"><option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option></select>
      </div>
    </div>
    <div class="controls" style="margin-bottom:8px">
      <button class="btn" onclick="refreshDashboard()">üîÑ ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÉ‡∏´‡∏°‡πà</button>
    </div>
    <div id="dashSummary" style="margin:8px 0;font-weight:700">‚Äî</div>
    <table id="dashTable">
      <thead><tr><th>‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î</th><th>‡∏≠‡∏≥‡πÄ‡∏†‡∏≠</th><th>‡∏ï‡∏≥‡∏ö‡∏•</th><th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á</th></tr></thead>
      <tbody></tbody>
    </table>
    <div class="hint">* ‡∏Å‡∏£‡∏≠‡∏á‡∏ó‡∏µ‡∏•‡∏∞‡∏ä‡∏±‡πâ‡∏ô‡πÑ‡∏î‡πâ‡∏ï‡∏≤‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ ‡πÅ‡∏•‡πâ‡∏ß‡∏î‡∏π‡∏ú‡∏•‡∏£‡∏ß‡∏°/‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô</div>
  </section>

  <!-- SECTION: ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å (LINE QR) -->
  <section id="lineSec" class="section hidden" style="text-align:center">
    <div class="menu-title">
      <span class="back" onclick="backHome()">‚Üê ‡∏Å‡∏•‡∏±‡∏ö</span> üí¨ ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å (‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô LINE)
    </div>
    <img id="lineQR" src="" alt="LINE QR" style="max-width:360px;width:100%;border-radius:12px;border:1px solid var(--border);background:#fff"/>
    <div class="hint" style="margin-top:8px">‡∏™‡πÅ‡∏Å‡∏ô QR ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô LINE</div>
  </section>

  <!-- SECTION: ‡∏ü‡∏≠‡∏£‡πå‡∏° -->
  <section id="formSec" class="section hidden">
    <div class="menu-title">
      <span class="back" onclick="backHome()">‚Üê ‡∏Å‡∏•‡∏±‡∏ö</span> üìù ‡∏Å‡∏£‡∏≠‡∏Å‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏≠‡∏≠‡∏Å‡∏´‡∏≤‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤
    </div>
    <form id="visitForm">
      <div class="row cols-3">
        <div>
          <label>üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà <span style="color:#ef4444">*</span></label>
          <input type="date" id="date" required />
        </div>
        <div>
          <label>üë• Team <span style="color:#ef4444">*</span></label>
          <select id="team" required><option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏µ‡∏°</option><option>A</option><option>B</option><option>C</option><option>D</option></select>
        </div>
        <div>
          <label>üßë‚Äçüíº ‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô (‡∏´‡∏•‡∏≤‡∏¢‡∏Ñ‡∏ô)</label>
          <div id="staffChips" class="chips"><input id="chipInput" class="chip-input" type="text" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡πâ‡∏ß Enter/,"></div>
          <div class="hint">‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏î‡πâ‡∏´‡∏•‡∏≤‡∏¢‡∏Ñ‡∏ô: ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î Enter ‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡∏≠‡∏°‡∏°‡∏≤ ,</div>
        </div>
      </div>

      <div class="row cols-3">
        <div><label>üìç ‡∏´‡∏ô‡πâ‡∏≤‡∏á‡∏≤‡∏ô</label><input type="text" id="siteName" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏ö‡πâ‡∏≤‡∏ô ABC"></div>
        <div><label>üßæ ‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</label><input type="text" id="customerName" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô/‡∏ú‡∏π‡πâ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠"></div>
        <div><label>üì± ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</label><input type="tel" id="phone" placeholder="0XXXXXXXXX"></div>
      </div>

      <div class="row cols-2">
        <div>
          <label>üè¢ ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à <span style="color:#ef4444">*</span></label>
          <select id="businessType" required>
            <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à</option>
            <option>‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ä‡πà‡∏ß‡∏á-‡∏£‡πâ‡∏≤‡∏ô‡∏ß‡∏±‡∏™‡∏î‡∏∏‡∏Å‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á</option>
            <option>‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ä‡πà‡∏ß‡∏á-‡∏£‡πâ‡∏≤‡∏ô‡∏ß‡∏±‡∏™‡∏î‡∏∏‡∏≠‡∏∑‡πà‡∏ô‡πÜ</option>
            <option>‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏´‡∏°‡∏≤‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•‡∏ò‡∏£‡∏£‡∏°‡∏î‡∏≤ ‡πÄ‡∏ä‡πà‡∏ô ‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏ö‡πâ‡∏≤‡∏ô‡∏à‡∏±‡∏î‡∏™‡∏£‡∏£</option>
            <option>‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏´‡∏°‡∏≤‡∏ô‡∏¥‡∏ï‡∏¥‡∏ö‡∏∏‡∏Ñ‡∏•</option>
            <option>‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£ (‡∏£‡∏ß‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏®‡∏∂‡∏Å‡∏©‡∏≤)</option>
            <option>‡πÇ‡∏£‡∏á‡πÅ‡∏£‡∏° ‡∏£‡∏µ‡∏™‡∏≠‡∏£‡πå‡∏ó ‡∏≠‡∏û‡∏≤‡∏£‡πå‡∏ó‡πÄ‡∏°‡πâ‡∏ô‡∏ï‡πå</option>
            <option>‡∏ß‡∏±‡∏î/‡∏°‡∏π‡∏•‡∏ô‡∏¥‡∏ò‡∏¥</option>
            <option>‡∏ô‡∏¥‡∏ï‡∏¥‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•(‡∏ò‡∏∏‡∏£‡∏∞‡∏Å‡∏¥‡∏à‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ)/‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏Å‡∏¥‡∏à‡∏Å‡∏≤‡∏£</option>
            <option>‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•‡∏ò‡∏£‡∏£‡∏°‡∏î‡∏≤</option>
            <option>‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô</option>
            <option>‡∏£‡πâ‡∏≤‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£ ‡∏Ñ‡∏≤‡πÄ‡∏ü‡πà</option>
          </select>
        </div>
        <div>
          <label>üß∞ ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ</label>
          <select id="productType">
            <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</option>
            <option>‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏ä‡πà‡∏≤‡∏á</option><option>‡∏Æ‡∏≤‡∏£‡πå‡∏î‡πÅ‡∏ß‡∏£‡πå</option><option>‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏™‡∏ß‡∏ô-‡∏õ‡∏£‡∏∞‡∏õ‡∏≤/‡∏õ‡∏±‡πâ‡∏°‡∏ô‡πâ‡∏≥</option>
            <option>‡∏õ‡∏£‡∏∞‡∏ï‡∏π-‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á/‡∏•‡∏π‡∏Å‡∏ö‡∏¥‡∏î</option><option>‡∏™‡∏µ‡πÅ‡∏•‡∏∞‡πÄ‡∏Ñ‡∏°‡∏µ‡∏†‡∏±‡∏ì‡∏ë‡πå/‡∏Ñ‡∏¥‡πâ‡∏ß‡πÑ‡∏°‡πâ</option><option>‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô/‡∏Å‡∏¥‡πä‡∏ü‡∏ä‡πá‡∏≠‡∏õ</option>
            <option>‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡πÑ‡∏ü‡∏ü‡πâ‡∏≤</option><option>‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Ñ‡∏£‡∏±‡∏ß‡∏ö‡∏≤‡∏ô‡∏ã‡∏¥‡∏á‡∏Ñ‡πå</option><option>‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡∏ö‡πâ‡∏≤‡∏ô</option>
            <option>‡πÄ‡∏ü‡∏≠‡∏£‡πå‡∏ô‡∏¥‡πÄ‡∏à‡∏≠‡∏£‡πå/‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ô‡∏≠‡∏ô</option><option>‡∏™‡∏∏‡∏Ç‡∏†‡∏±‡∏ì‡∏ë‡πå/‡∏Å‡∏£‡∏∞‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á</option><option>‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÑ‡∏ü‡∏ü‡πâ‡∏≤/‡πÇ‡∏Ñ‡∏°‡πÑ‡∏ü‡∏ï‡∏Å‡πÅ‡∏ï‡πà‡∏á</option>
          </select>
        </div>
      </div>

      <div class="row cols-3">
        <div><label>üí∏ ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡∏Å‡∏≤‡∏£‡∏ì‡πå</label><input type="text" id="estRevenue" placeholder="‡πÄ‡∏ä‡πà‡∏ô 50,000"></div>
        <div><label>üè™ ‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ã‡∏∑‡πâ‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏π‡πà‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</label><input type="text" id="currentSupplier" placeholder="‡πÄ‡∏ä‡πà‡∏ô DoHome, ‡∏£‡πâ‡∏≤‡∏ô A"></div>
        <div><label>üìù ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏û‡∏ö</label><input type="text" id="visitDetails" placeholder="‡∏õ‡∏£‡∏∞‡πÄ‡∏î‡πá‡∏ô, ‡πÇ‡∏≠‡∏Å‡∏≤‡∏™, ‡∏õ‡∏±‡∏ç‡∏´‡∏≤..."></div>
      </div>

      <div class="row cols-3">
        <div>
          <label>üß≠ ‡∏û‡∏¥‡∏Å‡∏±‡∏î Latitude:Longitude</label>
          <input type="text" id="latlng" placeholder="13.7563:100.5018">
          <div class="hint">‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏∂‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</div>
        </div>
        <div>
          <label>üìè ‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á‡∏à‡∏≤‡∏Å‡∏®‡∏π‡∏ô‡∏¢‡πå (‡∏Å‡∏°.)</label>
          <input type="text" id="distanceKm" placeholder="‚Äî" readonly>
          <div class="hint">‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏à‡∏≤‡∏Å (15.7053493,100.053933)</div>
        </div>
        <div>
          <label>üó∫Ô∏è ‡∏ï‡∏≥‡∏ö‡∏• / ‡∏≠‡∏≥‡πÄ‡∏†‡∏≠ / ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î</label>
          <input type="text" id="thaiAddress" placeholder="‡∏ï‡∏≥‡∏ö‡∏•, ‡∏≠‡∏≥‡πÄ‡∏†‡∏≠, ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î">
        </div>
      </div>

      <div class="controls" style="margin-bottom:14px">
        <button class="btn" type="button" id="btnLocate">üìå ‡∏î‡∏∂‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ï‡∏±‡πâ‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</button>
        <button class="btn" type="button" id="btnReverse">üîé ‡πÅ‡∏õ‡∏•‡∏á‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÄ‡∏õ‡πá‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà</button>
        <button class="btn" type="button" id="btnDistance">üìê ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á (‡∏ñ‡∏ô‡∏ô)</button>
      </div>

      <div class="row">
        <div>
          <label>üñºÔ∏è ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏´‡∏ô‡πâ‡∏≤‡∏á‡∏≤‡∏ô (‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 4 ‡∏£‡∏π‡∏õ)</label>
          <input type="file" id="photos" accept="image/*" multiple>
          <div class="hint">‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô Base64 ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠</div>
        </div>
      </div>

      <button class="primary" type="submit">üöÄ ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
      <div class="status" id="status"></div>
      <div class="hint" style="margin-top:8px">* ‡∏™‡πà‡∏á‡πÄ‡∏Ç‡πâ‡∏≤ Excel Online ‡∏ú‡πà‡∏≤‡∏ô Power Automate</div>
    </form>
  </section>
</div>

<script>
/** ====== CONFIG (‡πÅ‡∏Å‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ) ====== **/
const GOOGLE_API_KEY = "AIzaSyDheFpt9gmMH_6Rb3vEKihQZTw2GvZ5NbA"; // ‡∏Ñ‡∏µ‡∏¢‡πå‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏¥‡∏î Maps JS + Geocoding + Distance Matrix
const FLOW_URL = "https://default7f8918d9718a495bac9a17cba381c4.a0.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/3fee42520beb4c8eb71681e16d855bc6/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=-4RKokdpWKN2vEnePJPmT-xg_J3SrgSeuWBzmGaXVsk"; // URL Flow ‡∏£‡∏±‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ü‡∏≠‡∏£‡πå‡∏°
const DATA_URL = "https://dohomegroup-my.sharepoint.com/:x:/r/personal/d1-ns_dohome_co_th/_layouts/15/Doc.aspx?sourcedoc=%7BF10C79ED-F689-4D26-92F1-E33E46CFFD9F%7D&file=Small%20B2B.xlsx&action=default&mobileredirect=true";  // (‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å) ‡πÉ‡∏™‡πà‡∏•‡∏¥‡∏á‡∏Å‡πå JSON/CSV ‡∏£‡∏ß‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÄ‡∏Ñ‡∏¢‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà/‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î)
const LINE_QR_URL = "assets/line_qr.png"; // ‡∏£‡∏π‡∏õ QR LINE ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì (‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏™‡πà assets/ ‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏ä‡πâ‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏†‡∏≤‡∏û‡∏ï‡∏£‡∏á)

/** ====== ‡∏ò‡∏µ‡∏°/‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô ====== **/
const ORIGIN = { lat: 15.7053493, lng: 100.053933 };
document.getElementById('lineQR').src = LINE_QR_URL;
(() => { const d=new Date(); const tz=d.getTimezoneOffset()*60000; const today=new Date(Date.now()-tz).toISOString().slice(0,10); const el=document.getElementById('date'); if(el) el.value=today; })();

/** ====== ‡πÄ‡∏°‡∏ô‡∏π/‡πÄ‡∏ô‡∏ß‡∏¥‡πÄ‡∏Å‡∏ä‡∏±‡∏ô ====== **/
function openSection(id){
  document.getElementById('home').classList.add('hidden');
  ['mapSec','dashSec','lineSec','formSec'].forEach(k=>document.getElementById(k).classList.add('hidden'));
  document.getElementById(id).classList.remove('hidden');
  if(id==='mapSec'){ initMapOnce(); refreshMap(); }
  if(id==='dashSec'){ loadData().then(buildFilters).then(refreshDashboard).catch(console.warn); }
}
function backHome(){
  ['mapSec','dashSec','lineSec','formSec'].forEach(k=>document.getElementById(k).classList.add('hidden'));
  document.getElementById('home').classList.remove('hidden');
}

/** ====== MULTI STAFF (‡∏ä‡∏¥‡∏õ) ====== **/
const staffChips = document.getElementById('staffChips');
const chipInput = document.getElementById('chipInput');
let staffList = [];
function addChip(text){
  const name = (text||'').trim(); if(!name) return;
  if(staffList.includes(name)) return;
  staffList.push(name);
  const chip=document.createElement('span'); chip.className='chip';
  chip.innerHTML = name + ' <button title="‡∏•‡∏ö">√ó</button>';
  chip.querySelector('button').addEventListener('click', ()=>{ staffList = staffList.filter(n=>n!==name); chip.remove(); });
  staffChips.insertBefore(chip, chipInput); chipInput.value='';
}
chipInput.addEventListener('keydown', e=>{
  if(e.key==='Enter' || e.key===','){ e.preventDefault(); addChip(chipInput.value); }
  else if(e.key==='Backspace' && chipInput.value==='' && staffList.length){
    staffList.pop(); const chips=staffChips.querySelectorAll('.chip'); if(chips.length) chips[chips.length-1].remove();
  }
});
staffChips?.addEventListener('click', ()=>chipInput.focus());

/** ====== ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û (‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 4) ====== **/
let photosBase64 = [];
document.getElementById('photos')?.addEventListener('change', async (e)=>{
  photosBase64 = [];
  const files = Array.from(e.target.files||[]).slice(0,4);
  for(const f of files){ photosBase64.push(await fileToDataURL(f)); }
});
function fileToDataURL(file){ return new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(file); }); }

/** ====== ‡∏õ‡∏∏‡πà‡∏°‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á/‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà/‡∏ñ‡∏ô‡∏ô ====== **/
document.getElementById('btnLocate')?.addEventListener('click', ()=>{
  const status = document.getElementById('status');
  if(!navigator.geolocation){ status.innerHTML='<span class="error">‡∏ö‡∏£‡∏≤‡∏ß‡πÄ‡∏ã‡∏≠‡∏£‡πå‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</span>'; return; }
  status.textContent='‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‚Ä¶';
  navigator.geolocation.getCurrentPosition(async pos=>{
    const lat=pos.coords.latitude.toFixed(7), lng=pos.coords.longitude.toFixed(7);
    document.getElementById('latlng').value = `${lat}:${lng}`;
    status.textContent='‡πÑ‡∏î‡πâ‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÅ‡∏•‡πâ‡∏ß ‚úÖ';
    await reverseGeocode(); await calcDistance(); // auto ‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á
  }, err=> status.innerHTML='<span class="error">‡∏î‡∏∂‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: '+err.message+'</span>', {enableHighAccuracy:true, timeout:15000});
});
document.getElementById('btnReverse')?.addEventListener('click', reverseGeocode);
document.getElementById('btnDistance')?.addEventListener('click', calcDistance);

async function reverseGeocode(){
  const status=document.getElementById('status');
  const latlng = (document.getElementById('latlng').value||'').trim();
  if(!latlng){ status.innerHTML='<span class="error">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏Å‡πà‡∏≠‡∏ô</span>'; return; }
  const [lat,lng] = latlng.split(':').map(Number);
  try{
    const url = new URL('https://maps.googleapis.com/maps/api/geocode/json');
    url.searchParams.set('latlng', `${lat},${lng}`); url.searchParams.set('language','th'); url.searchParams.set('key', GOOGLE_API_KEY);
    const res=await fetch(url); const data=await res.json();
    if(data.status!=='OK') throw new Error(data.status);
    const comp=data.results[0]?.address_components||[];
    const tambon = findLongName(comp,'administrative_area_level_3') || findLongName(comp,'sublocality') || '';
    const amphoe = findLongName(comp,'administrative_area_level_2') || '';
    const changwat = findLongName(comp,'administrative_area_level_1') || '';
    document.getElementById('thaiAddress').value = [tambon,amphoe,changwat].filter(Boolean).join(', ');
    status.textContent='‡πÅ‡∏õ‡∏•‡∏á‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÄ‡∏õ‡πá‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚úÖ';
  }catch(e){ status.innerHTML='<span class="error">Reverse geocode ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: '+e.message+'</span>'; }
}
function findLongName(components,type){ const it = components.find(c=>c.types.includes(type)); return it?it.long_name:null; }

async function calcDistance(){
  const status=document.getElementById('status');
  const latlng=(document.getElementById('latlng').value||'').trim();
  if(!latlng){ status.innerHTML='<span class="error">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏Å‡πà‡∏≠‡∏ô</span>'; return; }
  const [lat,lng] = latlng.split(':').map(Number);
  if(!window.google || !google.maps || !google.maps.DistanceMatrixService){ status.innerHTML='<span class="error">Google Maps API ‡∏¢‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡πÄ‡∏™‡∏£‡πá‡∏à</span>'; return; }
  status.textContent='‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á (‡∏ñ‡∏ô‡∏ô)‚Ä¶';
  const svc = new google.maps.DistanceMatrixService();
  svc.getDistanceMatrix({
    origins: [{lat:ORIGIN.lat, lng:ORIGIN.lng}],
    destinations: [{lat, lng}],
    travelMode: google.maps.TravelMode.DRIVING,
    unitSystem: google.maps.UnitSystem.METRIC
  }, (resp, statusCode)=>{
    if(statusCode!=='OK'){ status.innerHTML='<span class="error">‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: '+statusCode+'</span>'; return; }
    const el = resp.rows?.[0]?.elements?.[0];
    if(!el || el.status!=='OK'){ status.innerHTML='<span class="error">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå: '+(el?.status||'NO_RESULT')+'</span>'; return; }
    document.getElementById('distanceKm').value = (el.distance.value/1000).toFixed(2);
    status.textContent='‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á (‡∏ñ‡∏ô‡∏ô) ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚úÖ';
  });
}

/** ====== ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ Power Automate ====== **/
document.getElementById('visitForm')?.addEventListener('submit', async (e)=>{
  e.preventDefault();
  const status=document.getElementById('status'); status.textContent='‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‚Ä¶ üöö';
  if(staffList.length===0){ status.innerHTML='<span class="error">‡πÇ‡∏õ‡∏£‡∏î‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏Ñ‡∏ô</span>'; return; }
  const payload = {
    date: document.getElementById('date').value,
    team: document.getElementById('team').value,
    staffNames: staffList,
    staffNamesText: staffList.join(', '),
    siteName: document.getElementById('siteName').value,
    customerName: document.getElementById('customerName').value,
    phone: document.getElementById('phone').value,
    businessType: document.getElementById('businessType').value,
    productType: document.getElementById('productType').value,
    estRevenue: document.getElementById('estRevenue').value,
    currentSupplier: document.getElementById('currentSupplier').value,
    visitDetails: document.getElementById('visitDetails').value,
    latlng: document.getElementById('latlng').value,
    distanceKm: document.getElementById('distanceKm').value,
    thaiAddress: document.getElementById('thaiAddress').value,
    photosBase64: photosBase64,
    // secret ‡πÅ‡∏ö‡∏ö‡∏á‡πà‡∏≤‡∏¢ (‡πÑ‡∏õ‡∏ï‡∏±‡πâ‡∏á Condition ‡∏ï‡∏£‡∏ß‡∏à‡πÉ‡∏ô Flow)
    secret: "nsb2b-2025"
  };
  try{
    const res = await fetch(FLOW_URL, {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)});
    if(!res.ok) throw new Error('HTTP '+res.status);
    status.innerHTML='<span class="success">‡∏™‡πà‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à üéâ</span>';
    e.target.reset(); staffList=[]; staffChips.querySelectorAll('.chip').forEach(c=>c.remove()); photosBase64=[];
    const d=new Date(), tz=d.getTimezoneOffset()*60000; document.getElementById('date').value=new Date(Date.now()-tz).toISOString().slice(0,10);
    document.getElementById('distanceKm').value='';
  }catch(err){ status.innerHTML='<span class="error">‡∏™‡πà‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: '+err.message+'</span>'; }
});

/** ====== DATA LOADER (‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà/‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î) ====== **/
let cachedRecords = null;
// ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏Ñ‡∏≤‡∏î‡∏´‡∏ß‡∏±‡∏á: [{date, team, staffNamesText, siteName, customerName, thaiAddress, latlng}]
async function loadData(){
  if(cachedRecords) return cachedRecords;
  // 1) ‡∏ñ‡πâ‡∏≤ DATA_URL ‡∏ß‡πà‡∏≤‡∏á ‚Üí ‡πÉ‡∏ä‡πâ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÉ‡∏ô‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≥
  if(!DATA_URL){
    cachedRecords = [
      {date:'2025-10-01', team:'A', staffNamesText:'‡∏™‡∏°‡∏ä‡∏≤‡∏¢', siteName:'‡∏ö‡πâ‡∏≤‡∏ô A', customerName:'‡∏£‡πâ‡∏≤‡∏ô X', thaiAddress:'‡∏ï‡∏≥‡∏ö‡∏•‡∏ö‡∏≤‡∏á‡∏£‡∏±‡∏Å, ‡∏≠‡∏≥‡πÄ‡∏†‡∏≠‡∏ö‡∏≤‡∏á‡∏£‡∏±‡∏Å, ‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£', latlng:'13.736717:100.523186'},
      {date:'2025-10-03', team:'B', staffNamesText:'‡∏ß‡∏¥‡∏ä‡∏≤', siteName:'‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ B', customerName:'‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó Y', thaiAddress:'‡∏ï‡∏≥‡∏ö‡∏•‡∏®‡∏≤‡∏•‡∏≤‡∏¢‡∏≤, ‡∏≠‡∏≥‡πÄ‡∏†‡∏≠‡∏û‡∏∏‡∏ó‡∏ò‡∏°‡∏ì‡∏ë‡∏•, ‡∏ô‡∏Ñ‡∏£‡∏õ‡∏ê‡∏°', latlng:'13.803:100.327'},
      {date:'2025-10-05', team:'C', staffNamesText:'‡∏Å‡∏≤‡∏ô‡∏ï‡πå', siteName:'‡∏£‡∏µ‡∏™‡∏≠‡∏£‡πå‡∏ó C', customerName:'‡∏Ñ‡∏∏‡∏ì Z', thaiAddress:'‡∏ï‡∏≥‡∏ö‡∏•‡∏´‡∏±‡∏ß‡∏´‡∏¥‡∏ô, ‡∏≠‡∏≥‡πÄ‡∏†‡∏≠‡∏´‡∏±‡∏ß‡∏´‡∏¥‡∏ô, ‡∏õ‡∏£‡∏∞‡∏à‡∏ß‡∏ö‡∏Ñ‡∏µ‡∏£‡∏µ‡∏Ç‡∏±‡∏ô‡∏ò‡πå', latlng:'12.568:99.957'}
    ];
    return cachedRecords;
  }
  // 2) ‡∏ñ‡πâ‡∏≤ DATA_URL ‡∏ä‡∏µ‡πâ CSV ‡∏´‡∏£‡∏∑‡∏≠ JSON ‡∏™‡∏≤‡∏ò‡∏≤‡∏£‡∏ì‡∏∞
  const res = await fetch(DATA_URL);
  const text = await res.text();
  try{ // JSON
    const json = JSON.parse(text);
    cachedRecords = Array.isArray(json) ? json : json.items || [];
    return cachedRecords;
  }catch(_){
    // CSV ‡πÅ‡∏ö‡∏ö‡∏á‡πà‡∏≤‡∏¢: header ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ date,team,staffNamesText,siteName,customerName,thaiAddress,latlng
    const rows = text.trim().split(/\r?\n/).map(r=>r.split(','));
    const head = rows.shift().map(h=>h.trim());
    cachedRecords = rows.map(r=>{
      const o={}; head.forEach((h,i)=>o[h]= (r[i]||'').trim()); return o;
    });
    return cachedRecords;
  }
}

/** ====== MAP ====== **/
let map, markers=[], myLocationMarker=null, mapInited=false;
function initMapOnce(){
  if(mapInited) return;
  mapInited=true;
  map = new google.maps.Map(document.getElementById('map'), {
    center: {lat:ORIGIN.lat, lng:ORIGIN.lng}, zoom: 7, mapTypeControl:false, streetViewControl:false
  });
  new google.maps.Marker({position:{lat:ORIGIN.lat,lng:ORIGIN.lng}, map, label:'üè†', title:'‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á'});
}
async function refreshMap(){
  if(!window.google || !google.maps){ alert('Google Maps API ‡∏¢‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡πÄ‡∏™‡∏£‡πá‡∏à'); return; }
  const from = document.getElementById('mapFrom').value || '0000-01-01';
  const to = document.getElementById('mapTo').value || '9999-12-31';
  const team = document.getElementById('mapTeam').value || '';
  const data = await loadData();
  // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå marker ‡πÄ‡∏Å‡πà‡∏≤
  markers.forEach(m=>m.setMap(null)); markers=[];
  const filtered = data.filter(x=>{
    const okDate = (!x.date || (x.date>=from && x.date<=to));
    const okTeam = (!team || x.team===team);
    return okDate && okTeam && x.latlng && x.latlng.includes(':');
  });
  const bounds = new google.maps.LatLngBounds();
  filtered.forEach(r=>{
    const [lat,lng] = r.latlng.split(':').map(Number);
    const m = new google.maps.Marker({map, position:{lat,lng}});
    const info = new google.maps.InfoWindow({content: `
      <div style="font-size:14px"><b>${r.siteName||'-'}</b><br>
      ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤: ${r.customerName||'-'}<br>
      ‡∏ó‡∏µ‡∏°: ${r.team||'-'} ¬∑ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${r.date||'-'}<br>
      ‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà: ${r.thaiAddress||'-'}</div>`});
    m.addListener('click', ()=>info.open({anchor:m,map}));
    markers.push(m); bounds.extend(m.getPosition());
  });
  if(filtered.length){ map.fitBounds(bounds); if(map.getZoom()>15) map.setZoom(15); }
}
function locateOnMap(){
  if(!navigator.geolocation){ alert('‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á'); return; }
  navigator.geolocation.getCurrentPosition(pos=>{
    const p = {lat:pos.coords.latitude, lng:pos.coords.longitude};
    if(myLocationMarker) myLocationMarker.setMap(null);
    myLocationMarker = new google.maps.Marker({map, position:p, label:'üìç', title:'‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô'});
    map.setCenter(p); map.setZoom(14);
  }, err=> alert('‡∏≠‡πà‡∏≤‡∏ô‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: '+err.message), {enableHighAccuracy:true, timeout:10000});
}

/** ====== DASHBOARD ====== **/
function splitThaiAddress(addr){
  // ‡∏Ñ‡∏≤‡∏î‡∏´‡∏ß‡∏±‡∏á‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö "‡∏ï‡∏≥‡∏ö‡∏•‚Ä¶, ‡∏≠‡∏≥‡πÄ‡∏†‡∏≠‚Ä¶, ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‚Ä¶"
  const parts = (addr||'').split(',').map(s=>s.trim());
  return {
    tambon: parts[0]||'',
    amphoe: parts[1]||'',
    changwat: parts[2]||''
  };
}
async function buildFilters(){
  const data = await loadData();
  // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏ã‡πá‡∏ï‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏á
  const setC=new Set(), setA=new Set(), setT=new Set();
  data.forEach(r=>{
    const {changwat, amphoe, tambon} = splitThaiAddress(r.thaiAddress||'');
    if(changwat) setC.add(changwat);
    if(amphoe) setA.add(amphoe);
    if(tambon) setT.add(tambon);
  });
  fillSelect('filterChangwat', setC);
  fillSelect('filterAmphoe', setA);
  fillSelect('filterTambon', setT);
}
function fillSelect(id, set){
  const el=document.getElementById(id); const cur=el.value;
  el.innerHTML='<option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>' + Array.from(set).sort().map(v=>`<option>${v}</option>`).join('');
  // ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡∏Ñ‡∏á‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ß‡πâ
  if(cur && Array.from(set).includes(cur)) el.value=cur;
}
async function refreshDashboard(){
  const data = await loadData();
  const fC = document.getElementById('filterChangwat').value||'';
  const fA = document.getElementById('filterAmphoe').value||'';
  const fT = document.getElementById('filterTambon').value||'';
  const filtered = data.filter(r=>{
    const {changwat, amphoe, tambon} = splitThaiAddress(r.thaiAddress||'');
    const okC = !fC || changwat===fC;
    const okA = !fA || amphoe===fA;
    const okT = !fT || tambon===fT;
    return okC && okA && okT;
  });
  // ‡∏™‡∏£‡∏∏‡∏õ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ï‡∏≤‡∏° ‡∏à/‡∏≠/‡∏ï (‡∏ï‡∏≤‡∏°‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏ó‡∏µ‡πà‡∏°‡∏µ)
  const agg = {};
  filtered.forEach(r=>{
    const {changwat, amphoe, tambon} = splitThaiAddress(r.thaiAddress||'');
    const k = [changwat||'-', amphoe||'-', tambon||'-'].join('|');
    agg[k] = (agg[k]||0)+1;
  });
  const rows = Object.entries(agg).map(([k,n])=>{
    const [c,a,t] = k.split('|'); return {c,a,t,n};
  }).sort((x,y)=> y.n - x.n);

  document.getElementById('dashSummary').innerText = `‡∏£‡∏ß‡∏° ${filtered.length} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á ¬∑ ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏à‡∏≠‡∏ö‡πà‡∏≠‡∏¢‡∏™‡∏∏‡∏î ${rows[0]? rows[0].c+'/'+rows[0].a+'/'+rows[0].t+' ('+rows[0].n+' ‡∏Ñ‡∏£‡∏±‡πâ‡∏á)' : '-'}`;
  const tbody=document.querySelector('#dashTable tbody'); tbody.innerHTML = rows.map(r=>`<tr><td>${r.c}</td><td>${r.a}</td><td>${r.t}</td><td>${r.n}</td></tr>`).join('') || '<tr><td colspan="4">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>';
}
</script>
</body>
</html>
